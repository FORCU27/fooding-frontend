'use client';
import { useRouter } from 'next/navigation';
import { useCallback, useEffect, useState } from 'react';

import { Box, Button, Card, CardContent, Typography } from '@mui/material';
import { AuthSocialLoginBody } from '@repo/api/auth';
import { GoogleIcon } from '@repo/design-system/icons';

import { useAuth } from '@/components/Provider/AuthProvider';
import { env } from '@/configs/env';

const openSocialLoginPopup = (loginUrl: string) => {
  const width = 500;
  const height = 600;
  const left = window.screenX + (window.outerWidth - width) / 2;
  const top = window.screenY + (window.outerHeight - height) / 2;

  return window.open(
    loginUrl,
    'login-popup',
    `width=${width},height=${height},left=${left},top=${top}`,
  );
};

const allowedOrigins = [
  'http://localhost:3000',
  'https://back-office-stage.fooding.im',
  'https://back-office.fooding.im',
];

export default function LoginPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);

  const { socialLogin } = useAuth();

  const handleMessage = useCallback(
    async (event: MessageEvent) => {
      if (!allowedOrigins.includes(event.origin)) return;
      if (!event.data?.code) return;

      window.removeEventListener('message', handleMessage);
      setIsLoading(true);

      try {
        const credentials: AuthSocialLoginBody = {
          code: event.data.code,
          provider: 'GOOGLE',
          redirectUri: env.OAUTH_REDIRECT_URI || '',
          role: 'ADMIN',
        };

        await socialLogin(credentials);

        router.push('/');
      } catch (error) {
        console.error(error);
      } finally {
        setIsLoading(false);
      }
    },
    [router, socialLogin],
  );

  useEffect(() => {
    window.addEventListener('message', handleMessage);
    return () => {
      window.removeEventListener('message', handleMessage);
    };
  }, [handleMessage]);

  const handleSocialLogin = useCallback(() => {
    const GOOGLE_CLIENT_ID = env.GOOGLE_CLIENT_ID;
    const OAUTH_REDIRECT_URI = env.OAUTH_REDIRECT_URI;

    const loginUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${OAUTH_REDIRECT_URI}&response_type=code&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile`;

    const popup = openSocialLoginPopup(loginUrl);
    if (!popup) return;

    setIsLoading(true);

    const timer = setInterval(() => {
      if (popup.closed) {
        clearInterval(timer);
        setIsLoading(false);
      }
    }, 500);
  }, []);

  return (
    <Box
      display='flex'
      justifyContent='center'
      alignItems='center'
      minHeight='100vh'
      bgcolor='#f9fafb'
    >
      <Card
        sx={{
          width: 450,
          borderRadius: 3,
          boxShadow: 3,
          padding: 5,
        }}
      >
        <CardContent
          sx={{
            display: 'flex',
            flexDirection: 'column',
            textAlign: 'center',
            alignContent: 'center',
            justifyContent: 'center',
            padding: 5,
            gap: 5,
          }}
        >
          <AdminFoodingIcon />
          <Typography variant='body2' color='text.secondary'>
            Google 계정으로 로그인하고 서비스를 이용하세요
          </Typography>

          <Button
            variant='outlined'
            startIcon={<GoogleIcon />}
            onClick={() => handleSocialLogin()}
            disabled={isLoading}
            sx={{
              padding: 2,
              textTransform: 'none',
              borderRadius: 2,
              borderColor: '#dadce0',
              color: '#3c4043',
              fontWeight: 500,
              '&:hover': { bgcolor: '#f7f8f8' },
            }}
            fullWidth
          >
            Google 계정으로 로그인
          </Button>
        </CardContent>
      </Card>
    </Box>
  );
}

const AdminFoodingIcon = () => {
  return (
    <svg
      width='300'
      height='248'
      viewBox='0 0 300 248'
      fill='none'
      xmlns='http://www.w3.org/2000/svg'
    >
      <path
        d='M219.777 134.665C214.18 111.95 204.68 90.5698 191.55 71.1241C186.552 63.7122 178.558 58.9021 169.64 57.9435C162.758 57.2074 155.928 58.8507 150.228 62.4797C144.528 58.8336 137.698 57.1903 130.817 57.9435C121.898 58.9021 113.905 63.7122 108.906 71.1241C95.7769 90.587 86.2766 111.967 80.6791 134.665C77.8204 146.202 82.4935 158.373 92.2677 164.946C99.1319 169.551 107.16 171.999 115.462 171.999C120.221 171.999 124.86 171.194 129.293 169.637C135.644 173.351 142.799 175.302 150.228 175.302C157.657 175.302 164.813 173.334 171.163 169.637C175.597 171.194 180.236 171.999 184.994 171.999C193.296 171.999 201.307 169.568 208.189 164.946C217.98 158.373 222.636 146.202 219.777 134.665ZM115.462 158.202C109.899 158.202 104.541 156.576 99.9536 153.495C94.9552 150.139 92.593 143.909 94.0651 137.969C99.286 116.846 108.119 96.9376 120.341 78.8271C123.062 74.7873 127.427 72.1683 132.306 71.6377C132.905 71.5692 133.487 71.535 134.086 71.535C136.226 71.535 138.331 71.9458 140.266 72.7503C140.009 73.0413 139.752 73.3494 139.495 73.6404C139.068 74.1197 138.64 74.6161 138.212 75.1125C137.647 75.763 137.099 76.4306 136.551 77.0982C136.158 77.5946 135.747 78.091 135.353 78.5874C134.822 79.2722 134.292 79.974 133.778 80.6587C133.419 81.138 133.059 81.6344 132.7 82.1137C132.169 82.8498 131.673 83.6029 131.176 84.3561C130.868 84.8183 130.56 85.2633 130.252 85.7255C129.687 86.5985 129.156 87.4715 128.626 88.3617C128.42 88.704 128.198 89.0464 127.992 89.3887C127.273 90.6212 126.589 91.8708 125.938 93.1204C125.801 93.3771 125.699 93.6339 125.562 93.8907C125.048 94.9006 124.552 95.8934 124.09 96.9205C123.884 97.3827 123.696 97.8449 123.49 98.2899C123.131 99.1116 122.771 99.9332 122.446 100.772C122.241 101.286 122.053 101.816 121.847 102.33C121.556 103.117 121.265 103.887 120.991 104.675C120.803 105.223 120.632 105.77 120.461 106.335C120.221 107.106 119.981 107.876 119.759 108.646C119.605 109.211 119.451 109.776 119.297 110.341C119.091 111.111 118.903 111.898 118.732 112.669C118.595 113.234 118.475 113.816 118.355 114.381C118.184 115.168 118.047 115.972 117.91 116.76C117.807 117.325 117.705 117.89 117.619 118.455C117.482 119.293 117.379 120.115 117.277 120.954C117.208 121.484 117.14 122.032 117.088 122.563C116.986 123.487 116.934 124.412 116.866 125.353C116.832 125.815 116.797 126.26 116.763 126.722C116.695 128.109 116.66 129.495 116.66 130.899C116.66 132.217 116.695 133.535 116.763 134.853C116.78 135.247 116.815 135.641 116.832 136.017C116.883 136.976 116.969 137.917 117.054 138.876C117.088 139.287 117.14 139.698 117.174 140.091C117.294 141.136 117.431 142.163 117.568 143.19C117.602 143.464 117.636 143.72 117.688 143.994C117.893 145.329 118.133 146.682 118.424 148C118.441 148.068 118.458 148.12 118.458 148.188C118.715 149.438 119.023 150.67 119.331 151.92C119.399 152.194 119.485 152.467 119.553 152.741C119.844 153.82 120.152 154.881 120.478 155.942C120.563 156.199 120.632 156.439 120.717 156.696C120.82 157.004 120.906 157.295 120.991 157.603C119.194 158.014 117.345 158.202 115.462 158.202ZM135.593 157.346C135.507 157.141 135.421 156.935 135.336 156.713C135.079 156.062 134.839 155.412 134.6 154.761C134.429 154.299 134.275 153.854 134.12 153.392C133.898 152.741 133.693 152.108 133.504 151.458C133.367 150.978 133.23 150.499 133.093 150.02C132.922 149.386 132.734 148.753 132.58 148.12C132.46 147.606 132.34 147.092 132.22 146.596C132.083 145.98 131.947 145.364 131.81 144.764C131.707 144.217 131.604 143.652 131.501 143.104C131.399 142.522 131.296 141.94 131.21 141.358C131.125 140.742 131.039 140.126 130.971 139.492C130.902 138.962 130.834 138.448 130.783 137.917C130.714 137.181 130.663 136.462 130.611 135.726C130.577 135.298 130.543 134.87 130.526 134.443C130.474 133.279 130.44 132.115 130.44 130.933C130.44 129.752 130.474 128.571 130.526 127.407C130.543 127.013 130.577 126.637 130.611 126.243C130.663 125.456 130.714 124.685 130.8 123.915C130.851 123.453 130.902 123.008 130.971 122.546C131.056 121.844 131.142 121.142 131.245 120.457C131.313 119.978 131.399 119.499 131.484 119.037C131.604 118.369 131.724 117.701 131.861 117.051C131.964 116.572 132.066 116.092 132.186 115.613C132.34 114.963 132.494 114.312 132.665 113.679C132.785 113.199 132.922 112.72 133.059 112.258C133.247 111.607 133.436 110.974 133.641 110.324C133.795 109.861 133.932 109.399 134.086 108.937C134.309 108.27 134.566 107.602 134.805 106.951C134.959 106.524 135.113 106.096 135.285 105.668C135.576 104.932 135.901 104.196 136.226 103.459C136.38 103.117 136.517 102.775 136.671 102.45C137.15 101.388 137.664 100.344 138.212 99.2999C138.331 99.0773 138.468 98.8377 138.588 98.6152C139.033 97.7935 139.478 96.989 139.941 96.1844C140.163 95.7907 140.403 95.4141 140.642 95.0376C141.036 94.3871 141.43 93.7366 141.841 93.1033C142.114 92.6753 142.405 92.2645 142.679 91.8537C143.09 91.2545 143.501 90.6554 143.912 90.0734C144.22 89.6455 144.528 89.2175 144.853 88.7896C145.281 88.2076 145.726 87.6427 146.171 87.0607C146.514 86.6328 146.839 86.2219 147.198 85.794C147.661 85.2291 148.14 84.6642 148.619 84.0993C148.979 83.6885 149.321 83.2777 149.698 82.8669C149.869 82.6786 150.04 82.5074 150.211 82.3191C150.382 82.5074 150.553 82.6786 150.725 82.8669C151.084 83.2777 151.444 83.6885 151.803 84.0993C152.282 84.6642 152.762 85.2291 153.224 85.794C153.566 86.2219 153.909 86.6328 154.251 87.0607C154.696 87.6256 155.141 88.2076 155.569 88.7896C155.894 89.2175 156.202 89.6455 156.51 90.0734C156.938 90.6725 157.349 91.2545 157.743 91.8537C158.034 92.2645 158.308 92.6924 158.582 93.1033C158.992 93.7366 159.386 94.3871 159.78 95.0376C160.02 95.4141 160.259 95.8079 160.482 96.1844C160.961 96.989 161.406 97.8106 161.834 98.6152C161.954 98.8377 162.091 99.0773 162.211 99.2999C162.758 100.344 163.272 101.388 163.751 102.45C163.905 102.792 164.042 103.117 164.196 103.459C164.522 104.196 164.847 104.932 165.138 105.668C165.309 106.096 165.463 106.524 165.617 106.951C165.874 107.619 166.113 108.27 166.336 108.937C166.49 109.399 166.644 109.861 166.781 110.324C166.986 110.974 167.192 111.607 167.363 112.258C167.5 112.737 167.62 113.217 167.757 113.679C167.928 114.329 168.082 114.963 168.236 115.613C168.339 116.092 168.459 116.572 168.561 117.051C168.698 117.719 168.818 118.369 168.938 119.037C169.023 119.516 169.109 119.995 169.178 120.457C169.28 121.159 169.366 121.844 169.451 122.546C169.503 123.008 169.571 123.453 169.623 123.915C169.708 124.685 169.76 125.473 169.811 126.243C169.845 126.637 169.879 127.013 169.896 127.407C169.948 128.571 169.982 129.752 169.982 130.933C169.982 132.097 169.948 133.279 169.896 134.443C169.879 134.836 169.845 135.213 169.811 135.607C169.76 136.377 169.708 137.164 169.623 137.935C169.571 138.397 169.52 138.842 169.451 139.304C169.366 140.006 169.28 140.708 169.178 141.409C169.109 141.889 169.006 142.385 168.938 142.864C168.818 143.532 168.715 144.2 168.578 144.85C168.476 145.346 168.356 145.843 168.253 146.339C168.116 146.99 167.962 147.623 167.791 148.274C167.671 148.77 167.517 149.266 167.38 149.78C167.209 150.413 167.021 151.047 166.832 151.663C166.678 152.159 166.507 152.673 166.353 153.169C166.148 153.786 165.942 154.402 165.72 155.018C165.531 155.514 165.36 156.011 165.155 156.507C165.035 156.798 164.915 157.089 164.813 157.363C160.413 160.085 155.398 161.506 150.194 161.506C145.007 161.506 139.992 160.068 135.593 157.346ZM200.503 153.495C195.915 156.576 190.558 158.202 184.994 158.202C183.111 158.202 181.246 158.014 179.431 157.654C179.517 157.414 179.568 157.192 179.654 156.952C179.791 156.541 179.91 156.114 180.047 155.686C180.321 154.813 180.578 153.94 180.818 153.049C180.937 152.622 181.04 152.211 181.16 151.783C181.417 150.756 181.673 149.711 181.896 148.667C181.947 148.428 182.016 148.188 182.067 147.931C182.324 146.647 182.564 145.364 182.769 144.08C182.82 143.737 182.872 143.378 182.923 143.018C183.06 142.06 183.18 141.101 183.3 140.143C183.351 139.698 183.385 139.253 183.437 138.825C183.522 137.9 183.591 136.976 183.642 136.052C183.659 135.641 183.693 135.247 183.71 134.836C183.779 133.518 183.813 132.217 183.813 130.899C183.813 129.495 183.779 128.109 183.71 126.722C183.693 126.26 183.642 125.815 183.608 125.353C183.539 124.429 183.488 123.504 183.385 122.58C183.334 122.032 183.248 121.502 183.197 120.954C183.094 120.115 182.992 119.293 182.855 118.455C182.769 117.89 182.666 117.325 182.564 116.76C182.427 115.972 182.273 115.168 182.119 114.381C181.999 113.799 181.862 113.234 181.742 112.669C181.571 111.898 181.365 111.111 181.177 110.341C181.023 109.776 180.869 109.194 180.715 108.629C180.492 107.859 180.253 107.088 180.013 106.318C179.842 105.77 179.654 105.205 179.465 104.658C179.191 103.87 178.918 103.1 178.627 102.313C178.421 101.782 178.233 101.268 178.027 100.738C177.702 99.9161 177.343 99.0945 176.983 98.2728C176.778 97.8106 176.589 97.3484 176.384 96.8863C175.922 95.8763 175.443 94.8835 174.929 93.8907C174.792 93.6168 174.672 93.36 174.535 93.0861C173.885 91.8365 173.2 90.587 172.498 89.3545C172.293 88.995 172.07 88.6527 171.865 88.2932C171.334 87.4202 170.821 86.5472 170.256 85.6742C169.965 85.212 169.64 84.7498 169.332 84.2876C168.835 83.5516 168.339 82.7984 167.808 82.0623C167.449 81.5659 167.089 81.0695 166.73 80.5902C166.216 79.9055 165.703 79.2208 165.172 78.5361C164.778 78.0397 164.367 77.5261 163.974 77.0297C163.443 76.3793 162.895 75.7117 162.33 75.0612C161.903 74.5648 161.475 74.0684 161.03 73.572C160.773 73.281 160.533 72.99 160.276 72.699C162.758 71.689 165.48 71.2782 168.236 71.5863C173.115 72.117 177.462 74.736 180.201 78.7757C192.338 96.9376 201.188 116.828 206.409 137.969C207.864 143.909 205.501 150.139 200.503 153.495Z'
        fill='#111111'
      />
      <path
        d='M150.228 45.807C162.878 45.807 173.132 35.5527 173.132 22.9035C173.132 10.2542 162.878 0 150.228 0C137.579 0 127.325 10.2542 127.325 22.9035C127.325 35.5527 137.579 45.807 150.228 45.807Z'
        fill='#111111'
      />
      <path
        d='M277.285 247.543V213.774H299.953V219.557H284.282V227.766H298.787V233.55H284.282V241.759H300V247.543H277.285Z'
        fill='#111111'
      />
      <path
        d='M265.3 225.527C264.74 221.795 261.848 219.51 257.93 219.51C252.66 219.51 249.208 223.568 249.208 230.657C249.208 237.934 252.706 241.805 257.883 241.805C261.755 241.805 264.6 239.659 265.3 236.021L272.389 236.068C271.596 242.318 266.372 248.008 257.79 248.008C248.742 248.008 242.072 241.665 242.072 230.657C242.072 219.65 248.882 213.307 257.79 213.307C265.579 213.307 271.456 217.784 272.389 225.527H265.3Z'
        fill='#111111'
      />
      <path d='M237.036 213.774V247.543H230.04V213.774H237.036Z' fill='#111111' />
      <path
        d='M203.173 247.543V213.774H225.421V219.557H210.169V227.766H223.975V233.55H210.169V247.543H203.173Z'
        fill='#111111'
      />
      <path
        d='M176.307 247.543V213.774H198.555V219.557H183.303V227.766H197.109V233.55H183.303V247.543H176.307Z'
        fill='#111111'
      />
      <path
        d='M171.271 230.657C171.271 241.665 164.414 248.008 155.506 248.008C146.504 248.008 139.694 241.618 139.694 230.657C139.694 219.65 146.504 213.307 155.506 213.307C164.414 213.307 171.271 219.65 171.271 230.657ZM164.134 230.657C164.134 223.428 160.73 219.51 155.506 219.51C150.282 219.51 146.83 223.428 146.83 230.657C146.83 237.887 150.282 241.805 155.506 241.805C160.73 241.805 164.134 237.887 164.134 230.657Z'
        fill='#111111'
      />
      <path
        d='M97.6677 247.543V213.774H104.664V228.746H105.13L117.397 213.774H125.839L113.246 228.886L125.979 247.543H117.584L108.209 233.597L104.664 237.888V247.543H97.6677Z'
        fill='#111111'
      />
      <path
        d='M85.682 225.527C85.1223 221.795 82.2305 219.51 78.3126 219.51C73.042 219.51 69.5905 223.568 69.5905 230.657C69.5905 237.934 73.0887 241.805 78.2659 241.805C82.1372 241.805 84.9824 239.659 85.682 236.021L92.7716 236.068C91.9787 242.318 86.7548 248.008 78.1726 248.008C69.1241 248.008 62.4543 241.665 62.4543 230.657C62.4543 219.65 69.264 213.307 78.1726 213.307C85.9619 213.307 91.8387 217.784 92.7716 225.527H85.682Z'
        fill='#111111'
      />
      <path
        d='M36.0545 247.543H28.4985L40.2057 213.774H49.2076L60.8681 247.543H53.3587L50.8401 239.753H38.6198L36.0545 247.543ZM40.3922 234.296H49.0677L44.8232 221.376H44.59L40.3922 234.296Z'
        fill='#111111'
      />
      <path
        d='M0 247.543V213.774H13.4329C20.8956 213.774 24.627 217.365 24.627 222.449C24.627 226.414 22.0617 228.886 18.5635 229.679V230.005C22.3882 230.192 25.9796 233.223 25.9796 238.214C25.9796 243.578 21.9684 247.543 14.3191 247.543H0ZM12.9198 241.759C16.9777 241.759 18.7034 240.08 18.7034 237.561C18.7034 234.716 16.5579 232.71 13.1064 232.71H6.9963V241.759H12.9198ZM12.4068 227.906C15.3452 227.906 17.5374 226.274 17.5374 223.569C17.5374 221.143 15.765 219.464 12.5467 219.464H6.9963V227.906H12.4068Z'
        fill='#111111'
      />
    </svg>
  );
};
